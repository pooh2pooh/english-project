<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ ‚Äî Frontend</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    :root{
      --bg1:#ffffff;--bg2:#bed7e0;--bg3:#d3e4ec;
      --card:rgba(255,255,255,.08);
      --accent:#00c6ff;--accent2:#0072ff;--success:#009f60;--danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));color:#303030;min-height:100vh}
    .container{max-width:1100px;margin:auto;padding:20px}
    .card{background:var(--card);backdrop-filter:blur(14px);border-radius:22px;padding:24px;margin-bottom:24px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
    h1,h2,h3{margin-top:0}
    button{border:none;border-radius:14px;padding:10px 16px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;transition:.12s}
    button:hover{transform:translateY(-2px)}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:none;margin:6px 0 12px;font-family:inherit}
    .progress{margin-top:16px;margin-bottom:16px;height:10px;background:rgba(255,255,255,.2);border-radius:10px;overflow:hidden}
    .progress div{height:100%;background:linear-gradient(135deg,var(--success),#00cc66)}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .stats{display:flex;gap:14px;flex-wrap:wrap;font-weight:600}
    .badge{background:white;color:#000;border-radius:12px;padding:4px 10px;font-size:12px;font-weight:800;margin:4px;display:inline-flex;align-items:center;gap:8px}
    .badge .icon{font-size:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px}
    .item{background:#fff;color:#000;padding:8px 12px;border-radius:8px;margin:4px;cursor:grab;display:inline-block;transition:.12s;touch-action:none}
    .item.dragging-item{opacity:0.6;transform:scale(.98);box-shadow:0 6px 20px rgba(0,0,0,.35)}
    .dropzone{min-height:42px;border:2px dashed rgba(255,255,255,.4);border-radius:12px;padding:10px;margin-bottom:10px;transition:.12s;display:flex;align-items:center;justify-content:space-between;overflow:hidden}
    .dropzone.drag-over{border-color:var(--accent);background:rgba(0,198,255,0.06);transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.28)}
    .dropzone.filled{border-color:rgba(0,255,153,0.9);background:rgba(0,255,153,0.04);box-shadow:0 8px 24px rgba(0,0,0,.18)}
    /* vertical layout for dropzone (used under images) */
    .dropzone.vertical{flex-direction:column;align-items:center;gap:8px;padding:12px}
    .dropzone.vertical img{max-width:100%;height:auto;max-height:200px;border-radius:10px;object-fit:cover}
    .dropzone.vertical b{display:block;margin-top:6px;word-break:break-word;text-align:center;max-width:100%}
    .dropzone b{white-space:normal}
    .result.success{color:var(--success);font-weight:800}
    .result.fail{color:var(--danger);font-weight:800}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000}
    .modal{background:#0b1220;padding:18px;border-radius:12px;min-width:320px;color:#fff}
    .modal h4{margin:0 0 12px}
    .modal .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .modal .badge-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .modal .badge-option{padding:8px;border-radius:8px;background:rgba(255,255,255,0.04);cursor:pointer;display:flex;gap:8px;align-items:center}
    .modal .badge-option.selected{outline:2px solid var(--accent);transform:translateY(-2px)}
    .modal .badge-icon{font-size:18px}
    .teacher-create-badge{display:flex;gap:8px;flex-wrap:wrap}
    .teacher-create-badge input{flex:1;min-width:140px}
    @media(max-width:600px){.container{padding:12px}}

    /* touch ghost */
    .touch-ghost {
      position: fixed;
      pointer-events: none;
      background: #fff;
      color: #000;
      padding: 8px 10px;
      border-radius: 8px;
      transform: translate(-50%, -50%);
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      z-index: 20000;
      font-weight:700;
      white-space: nowrap;
      opacity: 0.95;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- LOGIN -->
    <transition name="fade">
      <div v-if="!user" class="container">
        <div class="card" style="max-width:420px;margin:12vh auto">
          <h2>–í—Ö–æ–¥</h2>
          <input v-model="login" placeholder="–õ–æ–≥–∏–Ω" />
          <select v-model="role">
            <option value="student">–°—Ç—É–¥–µ–Ω—Ç</option>
            <option value="teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</option>
          </select>
          <button @click="auth">–í–æ–π—Ç–∏</button>
        </div>
      </div>
    </transition>

    <!-- STUDENT -->
    <div v-if="user && role==='student'" class="container">
      <div class="topbar">
        <h2>–ü–∞–Ω–µ–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞ ‚Äî {{user.login}}</h2>
        <button style="background:#950a0a" @click="logout">–í—ã–π—Ç–∏</button>
      </div>

      <div class="stats">
        <span>‚≠ê XP {{xp}}</span>
        <span>üèÜ –£—Ä–æ–≤–µ–Ω—å {{level}}</span>
        <span>üî• –°–µ—Ä–∏—è {{streak}}</span>
        <span>üß¨ –ö–æ–º–±–æ x{{combo}}</span>
      </div>

      <div class="progress"><div :style="{width:progress+'%'}"></div></div>

      <!-- Student badges: show icon (from availableBadges mapping) -->
      <div class="card" v-if="user.badges && user.badges.length">
        <h3>–ê—á–∏–≤–∫–∏</h3>
        <div>
          <span v-for="b in user.badges" :key="b" class="badge">
            <span class="icon">{{badgeIconFromTitle(b)}}</span>
            <span>{{b}}</span>
          </span>
        </div>
      </div>

      <transition name="fade">
        <div v-if="!activeTask && !result">
          <h3>–ó–∞–¥–∞–Ω–∏—è –∫—É—Ä—Å–∞</h3>
          <div class="grid">
            <div v-for="t in tasks" :key="t.id" class="card">
              <h4>{{t.title}}</h4>
              <p>{{t.desc}}</p>
              <button @click="startTask(t)">–ù–∞—á–∞—Ç—å</button>
              <span v-if="completedSet.has(t.id)" style="margin-left:10px;color:var(--success);font-weight:700">‚úî –ø—Ä–æ–π–¥–µ–Ω–æ</span>
            </div>
          </div>
        </div>
      </transition>

      <!-- Active Task -->
      <transition name="fade">
        <div v-if="activeTask" class="card">
          <h3>{{activeTask.title}}</h3>

          <!-- MATCH -->
          <div v-if="activeTask.type==='match'">
            <div style="margin-bottom:12px">
              <span v-for="w in shuffled" :key="w.en" class="item"
                    :class="{'dragging-item': draggingItem === (w.en||w.text)}"
                    draggable="true"
                    @dragstart="dragStart(w)"
                    @dragend="dragEnd"
                    @touchstart.prevent="touchStart(w,$event)"
                    @touchmove.prevent="touchMove($event)"
                    @touchend.prevent="touchEnd($event)">{{w.en}}</span>
            </div>

            <div v-for="(z,index) in activeTask.data" :key="z.ru"
                 class="dropzone"
                 :data-drop-index="index"
                 :class="{'drag-over': dragOver === z, 'filled': z.answer}"
                 @dragenter.prevent="dragEnter(z)"
                 @dragleave.prevent="dragLeave(z)"
                 @dragover.prevent
                 @drop="drop(index)">
              <div style="flex:1">{{z.ru}}</div>
              <div style="min-width:120px;text-align:right"><b>{{z.answer||'...'}}</b></div>
            </div>
          </div>

          <!-- FILL -->
          <div v-if="activeTask.type==='fill'">
            <div v-for="q in activeTask.data" :key="q.text">
              <p>{{q.text}}</p>
              <input v-model="q.user" />
            </div>
          </div>

          <!-- TABLE -->
          <div v-if="activeTask.type==='table'">
            <table style="width:100%">
              <tr><th>–ì–ª–∞–≥–æ–ª</th><th>–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞</th><th>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞</th></tr>
              <tr v-for="q in activeTask.data" :key="q.base">
                <td>{{q.base}}</td>
                <td><input v-model="q.reg"></td>
                <td><input v-model="q.irreg"></td>
              </tr>
            </table>
          </div>

          <!-- TRIPLE: image + dropped text should be placed vertically under image -->
          <div v-if="activeTask.type==='triple'">
            <h4>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É</h4>
            <div style="display:flex;flex-wrap:wrap;gap:20px">
              <div v-for="(z,index) in activeTask.data" :key="z.title"
                   class="dropzone"
                   :data-drop-index="index"
                   :class="{'drag-over': dragOver === z, 'filled': z.answer, 'vertical': true}"
                   style="flex:1;min-width:150px;text-align:center"
                   @dragenter.prevent="dragEnter(z)"
                   @dragleave.prevent="dragLeave(z)"
                   @dragover.prevent
                   @drop="drop(index)">
                <img :src="imgBase + z.img" alt="" />
                <b>{{z.answer || '...'}}</b>
              </div>
            </div>

            <div style="margin-top:12px">
              <span v-for="w in shuffled" :key="w.text" class="item"
                    :class="{'dragging-item': draggingItem === (w.en||w.text)}"
                    draggable="true"
                    @dragstart="dragStart(w)"
                    @dragend="dragEnd"
                    @touchstart.prevent="touchStart(w,$event)"
                    @touchmove.prevent="touchMove($event)"
                    @touchend.prevent="touchEnd($event)">{{w.text}}</span>
            </div>
          </div>

          <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding: 0 10px;
            box-sizing: border-box;
          ">
            <button
              style="margin-left:10px;background:rgba(255,255,255,.12);color:#303030""
              @click="activeTask=null; result=null"
            >
              ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∑–∞–¥–∞–Ω–∏–π
            </button>
            <button @click="submitTask">
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </div>

        </div>
      </transition>

      <!-- Result -->
      <transition name="fade">
        <div v-if="result" class="card">
          <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
          <p :class="['result',resultOk?'success':'fail']">{{result}}</p>
          <p v-if="resultOk">+{{earned}} XP</p>
          <button @click="closeResult">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
      </transition>
    </div>

    <!-- TEACHER (unchanged) -->
    <div v-if="user && role==='teacher'" class="container">
      <div class="topbar">
        <h2>–ü–∞–Ω–µ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è ‚Äî {{user.login}}</h2>
        <div style="display:flex;gap:10px;align-items:center">
          <button style="background:#950a0a" @click="logout">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="card">
        <h3>–°–æ–∑–¥–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input v-model="newStudent" placeholder="–õ–æ–≥–∏–Ω —Å—Ç—É–¥–µ–Ω—Ç–∞" />
          <button @click="addStudent">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="card">
        <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±–µ–π–¥–∂</h3>
        <div class="teacher-create-badge">
          <input v-model="newBadgeId" placeholder="id (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)" />
          <input v-model="newBadgeTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è)" />
          <input v-model="newBadgeIcon" placeholder="–ò–∫–æ–Ω–∫–∞ (emoji –∏–ª–∏ URL)" />
          <button @click="createBadge">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <p style="opacity:.8;margin-top:8px">–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–π–¥–∂ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –∞—á–∏–≤–æ–∫.</p>
      </div>

      <div v-if="teacherError" class="card" style="background:rgba(255,50,50,0.08);">
        <strong>–û—à–∏–±–∫–∞:</strong> {{teacherError}}
      </div>

      <div v-if="students === null" class="card">–ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤...</div>
      <div v-else-if="students.length === 0" class="card">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ.</div>

      <div v-else>
        <div v-for="s in students" :key="s.login" class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <b>{{s.login}}</b> ‚Äî XP {{s.xp}}
              <div style="margin-top:8px">
                <span v-for="b in s.badges" :key="b" class="badge">
                  <span class="icon">{{badgeIconFromTitle(b)}}</span>
                  <span>{{b}}</span>
                </span>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button @click="openBadgeModal(s.login)">–í—ã–¥–∞—Ç—å –∞—á–∏–≤–∫—É</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Badge selection modal (teacher) -->
    <div v-if="showBadgeModal" class="modal-backdrop" @click.self="closeBadgeModal">
      <div class="modal">
        <h4>–í—ã–¥–∞—Ç—å –∞—á–∏–≤–∫—É —Å—Ç—É–¥–µ–Ω—Ç—É {{badgeTargetStudent}}</h4>

        <div class="badge-row">
          <div v-for="b in availableBadges" :key="b.id"
               :class="['badge-option', {selected: selectedBadgeId === b.id}]"
               @click="selectedBadgeId = b.id">
            <span class="badge-icon">{{b.icon || b.title.slice(0,2)}}</span>
            <div style="display:flex;flex-direction:column;align-items:flex-start">
              <strong>{{b.title}}</strong>
              <small style="opacity:.7">{{b.id}}</small>
            </div>
          </div>
        </div>

        <div class="controls">
          <button @click="confirmGiveBadge">–í—ã–¥–∞—Ç—å</button>
          <button style="background:rgba(255,255,255,.12)" @click="closeBadgeModal">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>