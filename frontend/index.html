<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ ‚Äî Frontend</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    /* ============================================
       CSS –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò
       ============================================ */
    :root {
      --bg1: #ffffff;
      --bg2: #bed7e0;
      --bg3: #d3e4ec;
      --card: rgba(255, 255, 255, 0.08);
      --accent: #00c6ff;
      --accent2: #0072ff;
      --success: #009f60;
      --danger: #ff6b6b;
      
      /* –ï–¥–∏–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏ –æ—Ç—Å—Ç—É–ø—ã */
      --spacing-xs: 8px;
      --spacing-sm: 12px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      
      --button-height: 44px;
      --button-padding-x: 20px;
      --border-radius: 12px;
      --border-radius-lg: 22px;
      
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
      --transition-slow: 0.4s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      color: #303030;
      min-height: 100vh;
    }

    /* ============================================
       –ö–û–ù–¢–ï–ô–ù–ï–†–´ –ò –ö–ê–†–¢–û–ß–ö–ò
       ============================================ */
    .container {
      max-width: 1100px;
      margin: auto;
      padding: var(--spacing-md);
    }

    .card {
      background: var(--card);
      backdrop-filter: blur(14px);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
    }

    /* ============================================
       –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê
       ============================================ */
    h1, h2, h3, h4 {
      margin-top: 0;
      margin-bottom: var(--spacing-md);
    }

    /* ============================================
       –ö–ù–û–ü–ö–ò (–µ–¥–∏–Ω—ã–π —Ä–∞–∑–º–µ—Ä)
       ============================================ */
    button {
      border: none;
      border-radius: var(--border-radius);
      padding: 0 var(--button-padding-x);
      height: var(--button-height);
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      transition: all var(--transition-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 198, 255, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    /* ============================================
       –§–û–†–ú–´
       ============================================ */
    input, select, textarea {
      width: 100%;
      padding: var(--spacing-sm);
      border-radius: var(--border-radius);
      border: none;
      margin: var(--spacing-xs) 0 var(--spacing-md);
      font-family: inherit;
      font-size: 14px;
      transition: box-shadow var(--transition-fast);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 198, 255, 0.2);
    }

    /* ============================================
       –ü–†–û–ì–†–ï–°–° –ë–ê–†
       ============================================ */
    .progress {
      margin: var(--spacing-md) 0;
      height: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress div {
      height: 100%;
      background: linear-gradient(135deg, var(--success), #00cc66);
      transition: width var(--transition-normal);
    }

    /* ============================================
       –®–ê–ü–ö–ê –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê
       ============================================ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-md);
      flex-wrap: wrap;
      margin-bottom: var(--spacing-lg);
    }

    .stats {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
      font-weight: 600;
      margin-bottom: var(--spacing-lg);
    }

    /* ============================================
       –ë–ï–ô–î–ñ–ò
       ============================================ */
    .badge {
      background: white;
      color: #000;
      border-radius: var(--border-radius);
      padding: 4px var(--spacing-sm);
      font-size: 12px;
      font-weight: 800;
      margin: var(--spacing-xs);
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      transition: transform var(--transition-fast);
    }

    .badge:hover {
      transform: scale(1.05);
    }

    .badge .icon {
      font-size: 16px;
    }

    /* ============================================
       –°–ï–¢–ö–ê –ó–ê–î–ê–ù–ò–ô
       ============================================ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: var(--spacing-lg);
    }

    /* ============================================
       DRAG AND DROP –≠–õ–ï–ú–ï–ù–¢–´
       ============================================ */
    .item {
      background: #fff;
      color: #000;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius);
      margin: var(--spacing-xs);
      cursor: grab;
      display: inline-block;
      transition: all var(--transition-fast);
      touch-action: none;
      user-select: none;
      font-weight: 600;
    }

    .item:active {
      cursor: grabbing;
    }

    .item.dragging-item {
      opacity: 0.6;
      transform: scale(0.98);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
    }

    /* ============================================
       –ó–û–ù–´ –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø
       ============================================ */
    .dropzone {
      min-height: 42px;
      border: 2px dashed rgba(255, 255, 255, 0.4);
      border-radius: var(--border-radius);
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
      transition: all var(--transition-normal);
      display: flex;
      align-items: center;
      justify-content: space-between;
      overflow: hidden;
    }

    .dropzone.drag-over {
      border-color: var(--accent);
      background: rgba(0, 198, 255, 0.06);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.28);
    }

    .dropzone.filled {
      border-color: rgba(0, 255, 153, 0.9);
      background: rgba(0, 255, 153, 0.04);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
    }

    /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è dropzone –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏ */
    .dropzone.vertical {
      flex-direction: column;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-sm);
    }

    .dropzone.vertical img {
      max-width: 100%;
      height: auto;
      max-height: 200px;
      border-radius: 10px;
      object-fit: cover;
      transition: transform var(--transition-fast);
    }

    .dropzone.vertical img:hover {
      transform: scale(1.02);
    }

    .dropzone.vertical b {
      display: block;
      margin-top: var(--spacing-xs);
      word-break: break-word;
      text-align: center;
      max-width: 100%;
    }

    .dropzone b {
      white-space: normal;
    }

    /* ============================================
       –†–ï–ó–£–õ–¨–¢–ê–¢–´
       ============================================ */
    .result.success {
      color: var(--success);
      font-weight: 800;
    }

    .result.fail {
      color: var(--danger);
      font-weight: 800;
    }

    /* ============================================
       –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û
       ============================================ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn var(--transition-normal);
      backdrop-filter: blur(4px);
    }

    .modal {
      background: #0b1220;
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      min-width: 320px;
      max-width: 90vw;
      color: #fff;
      animation: slideUp var(--transition-normal);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal h4 {
      margin: 0 0 var(--spacing-md);
    }

    .modal .controls {
      display: flex;
      gap: var(--spacing-sm);
      justify-content: flex-end;
      margin-top: var(--spacing-md);
    }

    .modal .badge-row {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      margin-top: var(--spacing-sm);
    }

    .modal .badge-option {
      padding: var(--spacing-xs);
      border-radius: var(--border-radius);
      background: rgba(255, 255, 255, 0.04);
      cursor: pointer;
      display: flex;
      gap: var(--spacing-xs);
      align-items: center;
      transition: all var(--transition-fast);
    }

    .modal .badge-option:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }

    .modal .badge-option.selected {
      outline: 2px solid var(--accent);
      background: rgba(0, 198, 255, 0.1);
    }

    .modal .badge-icon {
      font-size: 18px;
    }

    /* ============================================
       –§–û–†–ú–´ –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–Ø
       ============================================ */
    .teacher-create-badge {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
    }

    .teacher-create-badge input {
      flex: 1;
      min-width: 140px;
    }

    /* ============================================
       –¢–ê–ë–õ–ò–¶–´
       ============================================ */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th, table td {
      padding: var(--spacing-sm);
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    table th {
      font-weight: 700;
    }

    /* ============================================
       –í–ò–ó–£–ê–õ–¨–ù–´–ô –ü–†–ò–ó–†–ê–ö –î–õ–Ø TOUCH
       ============================================ */
    .touch-ghost {
      position: fixed;
      pointer-events: none;
      background: #fff;
      color: #000;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius);
      transform: translate(-50%, -50%);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      z-index: 20000;
      font-weight: 700;
      white-space: nowrap;
      opacity: 0.95;
      font-size: 14px;
      transition: opacity var(--transition-fast);
    }

    /* ============================================
       –ê–ù–ò–ú–ê–¶–ò–ò
       ============================================ */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-enter-active, .fade-leave-active {
      transition: opacity var(--transition-normal);
    }

    .fade-enter-from, .fade-leave-to {
      opacity: 0;
    }

    /* ============================================
       MOBILE-FIRST –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨
       ============================================ */
    @media (max-width: 600px) {
      .container {
        padding: var(--spacing-sm);
      }

      .card {
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
      }

      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }

      .stats {
        font-size: 14px;
      }

      .grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }

      button {
        width: 100%;
        margin-bottom: var(--spacing-xs);
      }

      .modal {
        min-width: auto;
        width: 95vw;
        padding: var(--spacing-md);
      }
    }

    /* ============================================
       –£–¢–ò–õ–ò–¢–´
       ============================================ */
    .flex {
      display: flex;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-md);
    }

    .flex-column {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    /* ============================================
       –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–î–ê–ù–ò–ï–ú
       ============================================ */
    .task-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .task-controls .btn-back,
    .task-controls .btn-submit {
      flex: 1 1 auto;
      min-width: 140px;
      white-space: nowrap;
    }

    /* –ù–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –∫–Ω–æ–ø–∫–∏ –¥—Ä—É–≥ –ø–æ–¥ –¥—Ä—É–≥–æ–º */
    @media (max-width: 600px) {
      .task-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .task-controls .btn-back,
      .task-controls .btn-submit {
        width: 100%;
        flex: 1 1 100%;
        min-width: 0;
        padding: 4% 0;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- ============================================
         –≠–ö–†–ê–ù –í–•–û–î–ê
         ============================================ -->
    <transition name="fade">
      <div v-if="!user" class="container">
        <div class="card" style="max-width:420px;margin:12vh auto">
          <h2>–í—Ö–æ–¥</h2>
          <input v-model="login" placeholder="–õ–æ–≥–∏–Ω" />
          <select v-model="role">
            <option value="student">–°—Ç—É–¥–µ–Ω—Ç</option>
            <option value="teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</option>
          </select>
          <button @click="auth">–í–æ–π—Ç–∏</button>
        </div>
      </div>
    </transition>

    <!-- ============================================
         –ü–ê–ù–ï–õ–¨ –°–¢–£–î–ï–ù–¢–ê
         ============================================ -->
    <div v-if="user && role==='student'" class="container">
      <!-- –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π –≤—ã—Ö–æ–¥–∞ -->
      <div class="topbar">
        <h2>–ü–∞–Ω–µ–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞ ‚Äî {{user.login}}</h2>
        <button style="background:#950a0a" @click="logout">–í—ã–π—Ç–∏</button>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="stats">
        <span>‚≠ê XP {{xp}}</span>
        <span>üèÜ –£—Ä–æ–≤–µ–Ω—å {{level}}</span>
        <span>üî• –°–µ—Ä–∏—è {{streak}}</span>
        <span>üß¨ –ö–æ–º–±–æ x{{combo}}</span>
      </div>

      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
      <div class="progress">
        <div :style="{width:progress+'%'}"></div>
      </div>

      <!-- –ê—á–∏–≤–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
      <div class="card" v-if="user.badges && user.badges.length">
        <h3>–ê—á–∏–≤–∫–∏</h3>
        <div>
          <span v-for="b in user.badges" :key="b" class="badge">
            <span class="icon">{{badgeIconFromTitle(b)}}</span>
            <span>{{b}}</span>
          </span>
        </div>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π -->
      <transition name="fade">
        <div v-if="!activeTask && !result">
          <h3>–ó–∞–¥–∞–Ω–∏—è –∫—É—Ä—Å–∞</h3>
          <div class="grid">
            <div v-for="t in tasks" :key="t.id" class="card">
              <h4>{{t.title}}</h4>
              <p>{{t.desc}}</p>
              <button @click="startTask(t)">–ù–∞—á–∞—Ç—å</button>
              <span v-if="completedSet.has(t.id)" style="margin-left:var(--spacing-sm);color:var(--success);font-weight:700">‚úî –ø—Ä–æ–π–¥–µ–Ω–æ</span>
            </div>
          </div>
        </div>
      </transition>

      <!-- ============================================
           –ê–ö–¢–ò–í–ù–û–ï –ó–ê–î–ê–ù–ò–ï
           ============================================ -->
      <transition name="fade">
        <div v-if="activeTask" class="card">
          <h3>{{activeTask.title}}</h3>

          <!-- –¢–∏–ø –∑–∞–¥–∞–Ω–∏—è: MATCH (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ) -->
          <div v-if="activeTask.type==='match'">
            <!-- –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è -->
            <div style="margin-bottom:var(--spacing-md)">
              <span v-for="w in shuffled" :key="w.en" class="item"
                    :class="{'dragging-item': draggingItem === (w.en||w.text)}"
                    draggable="true"
                    @dragstart="dragStart(w)"
                    @dragend="dragEnd"
                    @touchstart.prevent="touchStart(w,$event)"
                    @touchmove.prevent="touchMove($event)"
                    @touchend.prevent="touchEnd($event)">{{w.en}}</span>
            </div>

            <!-- –ó–æ–Ω—ã –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è -->
            <div v-for="(z,index) in activeTask.data" :key="z.ru"
                 class="dropzone"
                 :data-drop-index="index"
                 :class="{'drag-over': dragOver === z, 'filled': z.answer}"
                 @dragenter.prevent="dragEnter(z)"
                 @dragleave.prevent="dragLeave(z)"
                 @dragover.prevent="dragOverHandler"
                 @drop="drop(index)">
              <div style="flex:1">{{z.ru}}</div>
              <div style="min-width:120px;text-align:right"><b>{{z.answer||'...'}}</b></div>
            </div>
          </div>

          <!-- –¢–∏–ø –∑–∞–¥–∞–Ω–∏—è: FILL (–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ) -->
          <div v-if="activeTask.type==='fill'">
            <table>
              <tr><th></th><th></th></tr>
              <tr v-for="q in activeTask.data" :key="q.text">
                <td>{{q.text}}</td>
                <td><input v-model="q.user" /></td>
              </tr>
            </table>
          </div>

          <!-- –¢–∏–ø –∑–∞–¥–∞–Ω–∏—è: TABLE (—Ç–∞–±–ª–∏—Ü–∞) -->
          <div v-if="activeTask.type==='table'">
            <table>
              <tr><th>–ì–ª–∞–≥–æ–ª</th><th>–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞</th><th>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞</th></tr>
              <tr v-for="q in activeTask.data" :key="q.base">
                <td>{{q.base}}</td>
                <td><input v-model="q.reg"></td>
                <td><input v-model="q.irreg"></td>
              </tr>
            </table>
          </div>

          <!-- –¢–∏–ø –∑–∞–¥–∞–Ω–∏—è: TRIPLE (–∫–∞—Ä—Ç–∏–Ω–∫–∞ + —Ç–µ–∫—Å—Ç) -->
          <div v-if="activeTask.type==='triple'">
            <h4>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É</h4>
            <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∏ —Å –∑–æ–Ω–∞–º–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è -->
            <div style="display:flex;flex-wrap:wrap;gap:var(--spacing-lg)">
              <div v-for="(z,index) in activeTask.data" :key="z.title"
                   class="dropzone"
                   :data-drop-index="index"
                   :class="{'drag-over': dragOver === z, 'filled': z.answer, 'vertical': true}"
                   style="flex:1;min-width:150px;text-align:center"
                   @dragenter.prevent="dragEnter(z)"
                   @dragleave.prevent="dragLeave(z)"
                   @dragover.prevent="dragOverHandler"
                   @drop="drop(index)">
                <img :src="imgBase + z.img" alt="" />
                <b>{{z.answer || '...'}}</b>
              </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è -->
            <div style="margin-top:var(--spacing-md)">
              <span v-for="w in shuffled" :key="w.text" class="item"
                    :class="{'dragging-item': draggingItem === (w.en||w.text)}"
                    draggable="true"
                    @dragstart="dragStart(w)"
                    @dragend="dragEnd"
                    @touchstart.prevent="touchStart(w,$event)"
                    @touchmove.prevent="touchMove($event)"
                    @touchend.prevent="touchEnd($event)">{{w.text}}</span>
            </div>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–µ–º -->
          <div class="task-controls" style="margin-top:var(--spacing-md);padding:0 var(--spacing-sm)">
            <button
              class="btn-back"
              style="background:rgba(255,255,255,.12);color:#303030"
              @click="activeTask=null; result=null"
            >
              ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∑–∞–¥–∞–Ω–∏–π
            </button>
            <button class="btn-submit" @click="submitTask">
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>
      </transition>

      <!-- ============================================
           –†–ï–ó–£–õ–¨–¢–ê–¢ –í–´–ü–û–õ–ù–ï–ù–ò–Ø –ó–ê–î–ê–ù–ò–Ø
           ============================================ -->
      <transition name="fade">
        <div v-if="result" class="card">
          <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
          <p :class="['result',resultOk?'success':'fail']">{{result}}</p>
          <p v-if="resultOk">+{{earned}} XP</p>
          <button @click="closeResult">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
      </transition>
    </div>

    <!-- ============================================
         –ü–ê–ù–ï–õ–¨ –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–Ø
         ============================================ -->
    <div v-if="user && role==='teacher'" class="container">
      <!-- –®–∞–ø–∫–∞ -->
      <div class="topbar">
        <h2>–ü–∞–Ω–µ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è ‚Äî {{user.login}}</h2>
        <div class="flex" style="gap:var(--spacing-sm);align-items:center">
          <button style="background:#950a0a" @click="logout">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
      <div class="card">
        <h3>–°–æ–∑–¥–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>
        <div class="flex" style="gap:var(--spacing-xs);align-items:center">
          <input v-model="newStudent" placeholder="–õ–æ–≥–∏–Ω —Å—Ç—É–¥–µ–Ω—Ç–∞" />
          <button @click="addStudent">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–π–¥–∂–∞ -->
      <div class="card">
        <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±–µ–π–¥–∂</h3>
        <div class="teacher-create-badge">
          <input v-model="newBadgeId" placeholder="id (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)" />
          <input v-model="newBadgeTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è)" />
          <input v-model="newBadgeIcon" placeholder="–ò–∫–æ–Ω–∫–∞ (emoji –∏–ª–∏ URL)" />
          <button @click="createBadge">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <p style="opacity:.8;margin-top:var(--spacing-xs)">–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–π–¥–∂ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –∞—á–∏–≤–æ–∫.</p>
      </div>

      <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
      <div v-if="teacherError" class="card" style="background:rgba(255,50,50,0.08);">
        <strong>–û—à–∏–±–∫–∞:</strong> {{teacherError}}
      </div>

      <!-- –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
      <div v-if="students === null" class="card">–ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤...</div>
      <div v-else-if="students.length === 0" class="card">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ.</div>

      <div v-else>
        <div v-for="s in students" :key="s.login" class="card">
          <div class="flex-between">
            <div>
              <b>{{s.login}}</b> ‚Äî XP {{s.xp}}
              <div style="margin-top:var(--spacing-xs)">
                <span v-for="b in s.badges" :key="b" class="badge">
                  <span class="icon">{{badgeIconFromTitle(b)}}</span>
                  <span>{{b}}</span>
                </span>
              </div>
            </div>
            <div class="flex-column">
              <button @click="openBadgeModal(s.login)">–í—ã–¥–∞—Ç—å –∞—á–∏–≤–∫—É</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================
         –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–´–ë–û–†–ê –ê–ß–ò–í–ö–ò
         ============================================ -->
    <div v-if="showBadgeModal" class="modal-backdrop" @click.self="closeBadgeModal">
      <div class="modal">
        <h4>–í—ã–¥–∞—Ç—å –∞—á–∏–≤–∫—É —Å—Ç—É–¥–µ–Ω—Ç—É {{badgeTargetStudent}}</h4>

        <div class="badge-row">
          <div v-for="b in availableBadges" :key="b.id"
               :class="['badge-option', {selected: selectedBadgeId === b.id}]"
               @click="selectedBadgeId = b.id">
            <span class="badge-icon">{{b.icon || b.title.slice(0,2)}}</span>
            <div class="flex-column" style="align-items:flex-start">
              <strong>{{b.title}}</strong>
              <small style="opacity:.7">{{b.id}}</small>
            </div>
          </div>
        </div>

        <div class="controls">
          <button @click="confirmGiveBadge">–í—ã–¥–∞—Ç—å</button>
          <button style="background:rgba(255,255,255,.12)" @click="closeBadgeModal">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      // ============================================
      // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø API
      // ============================================
      endpoints: {
        tasks: 'http://localhost:3001/tasks',
        tasksImgsBase: '',
        studentsApi: 'http://localhost:3002',
        teacherApi: 'http://localhost:3003',
      },

      // ============================================
      // –°–û–°–¢–û–Ø–ù–ò–ï –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
      // ============================================
      login: '',
      role: 'student',
      user: null,

      // ============================================
      // –°–û–°–¢–û–Ø–ù–ò–ï –°–¢–£–î–ï–ù–¢–ê
      // ============================================
      xp: 0,
      level: 1,
      streak: 0,
      combo: 1,
      earned: 0,
      activeTask: null,
      shuffled: [],
      result: null,
      resultOk: false,
      tasks: [],
      imgBase: '',

      // ============================================
      // –°–û–°–¢–û–Ø–ù–ò–ï DRAG AND DROP
      // ============================================
      drag: null,
      dragOver: null,
      draggingItem: null,
      scrollAnimationFrame: null, // ID –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
      currentDragPosition: null, // –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞/–∫–∞—Å–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏

      // ============================================
      // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–Ø
      // ============================================
      students: null,
      newStudent: '',
      teacherError: '',

      // ============================================
      // –°–û–°–¢–û–Ø–ù–ò–ï –ë–ï–ô–î–ñ–ï–ô
      // ============================================
      availableBadges: [],
      showBadgeModal: false,
      badgeTargetStudent: null,
      selectedBadgeId: null,
      newBadgeId: '',
      newBadgeTitle: '',
      newBadgeIcon: '',
    };
  },

  computed: {
    // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–º–∞–∫—Å–∏–º—É–º 100%)
    progress() {
      return Math.min(100, Math.floor(this.xp / 10));
    },

    // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    completedSet() {
      return new Set((this.user && this.user.completedTasks) || []);
    }
  },

  methods: {
    // ============================================
    // –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° API
    // ============================================
    /**
     * –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π fetch —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
     * @param {string} url - URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
     * @param {object} opts - –û–ø—Ü–∏–∏ fetch
     * @returns {Promise<object>} –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
     */
    async fetchSafe(url, opts) {
      try {
        const res = await fetch(url, opts);
        const text = await res.text();
        let json = null;
        try {
          json = JSON.parse(text);
        } catch (e) {
          json = null;
        }
        return { ok: res.ok, status: res.status, json, text };
      } catch (e) {
        return { ok: false, status: 0, json: null, text: String(e) };
      }
    },

    // ============================================
    // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
    // ============================================
    /**
     * –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
     */
    async auth() {
      if (!this.login) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');

      if (this.role === 'student') {
        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞
        const url = this.endpoints.studentsApi + '/students';
        const res = await this.fetchSafe(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ login: this.login })
        });

        if (!res.ok) {
          alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (res.json?.error || res.text));
          return;
        }

        const user = res.json || (() => {
          try {
            return JSON.parse(res.text);
          } catch {
            return null;
          }
        })();

        if (!user) {
          alert('–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + res.text);
          return;
        }

        this.user = user;
        this.xp = user.xp || 0;
        this.level = Math.floor(this.xp / 50) + 1;
        await this.loadTasks();
        await this.loadAvailableBadges();
      } else {
        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
        this.students = null;
        const url = this.endpoints.teacherApi + '/teachers';
        const res = await this.fetchSafe(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ login: this.login })
        });

        if (!res.ok) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –∫–∞–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: ' + (res.json?.error || res.text));
          this.students = [];
          return;
        }

        const teacher = res.json || (() => {
          try {
            return JSON.parse(res.text);
          } catch {
            return null;
          }
        })();

        if (!teacher) {
          alert('–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç teacher-service: ' + res.text);
          this.students = [];
          return;
        }

        this.user = teacher;
        await this.loadStudents();
        await this.loadAvailableBadges();
      }
    },

    /**
     * –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
     */
    logout() {
      this.user = null;
      this.login = '';
      this.activeTask = null;
      this.result = null;
      this.teacherError = '';
      this.students = null;
      this.availableBadges = [];
      this.showBadgeModal = false;
    },

    // ============================================
    // –†–ê–ë–û–¢–ê –° –ó–ê–î–ê–ù–ò–Ø–ú–ò
    // ============================================
    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞–Ω–∏–π
     */
    async loadTasks() {
      const res = await this.fetchSafe(this.endpoints.tasks);
      if (!res.ok) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è: ' + (res.json?.error || res.text));
        this.tasks = [];
        return;
      }

      const data = res.json || (res.text ? JSON.parse(res.text || '{}') : {});
      this.tasks = data.tasks || [];
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º origin —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      this.imgBase = window.location.origin + '/';
    },

    /**
     * –ù–∞—á–∞–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è
     * @param {object} t - –ó–∞–¥–∞–Ω–∏–µ
     */
    startTask(t) {
      this.activeTask = JSON.parse(JSON.stringify(t));
      this.result = null;
      this.resultOk = false;
      this.dragOver = null;
      this.draggingItem = null;

      // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
      if (t.type === 'match') {
        this.shuffled = [...t.data].sort(() => Math.random() - 0.5);
      }
      if (t.type === 'triple') {
        this.shuffled = [...t.data].map(d => ({ text: d.text })).sort(() => Math.random() - 0.5);
      }
    },

    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
     */
    async submitTask() {
      let ok = true;
      const t = this.activeTask;
      if (!t) return;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
      if (t.type === 'match') {
        t.data.forEach(d => {
          if (d.answer !== d.en) ok = false;
        });
      }
      if (t.type === 'fill') {
        t.data.forEach(d => {
          if ((d.user || '').trim() !== (d.answer || '').trim()) ok = false;
        });
      }
      if (t.type === 'table') {
        t.data.forEach(d => {
          if ((d.reg || '').trim() === '' && (d.irreg || '').trim() === '') ok = false;
        });
      }
      if (t.type === 'triple') {
        t.data.forEach(d => {
          if (d.answer !== d.text) ok = false;
        });
      }

      this.resultOk = ok;

      if (ok) {
        // –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        this.earned = 20 * this.combo;
        this.xp += this.earned;
        this.combo++;
        this.streak++;
        this.result = '–£—Å–ø–µ—à–Ω–æ!';

        if (!this.user.completedTasks) this.user.completedTasks = [];
        if (!this.user.completedTasks.includes(t.id)) {
          this.user.completedTasks.push(t.id);
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        const url = `${this.endpoints.studentsApi}/students/${encodeURIComponent(this.user.login)}`;
        const res = await this.fetchSafe(url, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            xp: this.xp,
            completedTasks: this.user.completedTasks,
            badges: this.user.badges || []
          })
        });

        if (!res.ok) {
          console.warn('Failed to persist student progress:', res.status, res.text);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ' + (res.json?.error || res.text));
        }
      } else {
        // –ù–µ—É–¥–∞—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        this.combo = 1;
        this.streak = 0;
        this.earned = 0;
        this.result = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞';
      }

      this.level = Math.floor(this.xp / 50) + 1;
      this.activeTask = null;
    },

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
     */
    closeResult() {
      this.result = null;
    },

    // ============================================
    // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –°–ö–†–û–õ–õ –ü–†–ò –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ò
    // ============================================
    /**
     * –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
     */
    stopAutoScroll() {
      if (this.scrollAnimationFrame !== null) {
        cancelAnimationFrame(this.scrollAnimationFrame);
        this.scrollAnimationFrame = null;
      }
      this.currentDragPosition = null;
    },

    /**
     * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ –∫—Ä–∞—é —ç–∫—Ä–∞–Ω–∞
     * @param {number} x - X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –∫—É—Ä—Å–æ—Ä–∞/–∫–∞—Å–∞–Ω–∏—è
     * @param {number} y - Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –∫—É—Ä—Å–æ—Ä–∞/–∫–∞—Å–∞–Ω–∏—è
     */
    autoScroll(x, y) {
      this.currentDragPosition = { x, y };
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (this.scrollAnimationFrame !== null) {
        cancelAnimationFrame(this.scrollAnimationFrame);
      }
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª —Å–∫—Ä–æ–ª–ª–∞
      const scrollLoop = () => {
        if (!this.currentDragPosition || (!this.drag && !this.touchDragItem)) {
          this.scrollAnimationFrame = null;
          return;
        }
        
        const { x, y } = this.currentDragPosition;
        
        // –ó–æ–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–∫—Ä–æ–ª–ª–∞ (–≤ –ø–∏–∫—Å–µ–ª—è—Ö –æ—Ç –∫—Ä–∞—è)
        const scrollZone = 80;
        const scrollSpeed = 15; // –°–∫–æ—Ä–æ—Å—Ç—å —Å–∫—Ä–æ–ª–ª–∞
        
        const windowHeight = window.innerHeight;
        const windowWidth = window.innerWidth;
        
        let scrollX = 0;
        let scrollY = 0;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
        if (y < scrollZone) {
          // –°–∫—Ä–æ–ª–ª –≤–≤–µ—Ä—Ö (—á–µ–º –±–ª–∏–∂–µ –∫ –≤–µ—Ä—Ö—É, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ)
          const factor = Math.max(0, 1 - y / scrollZone);
          scrollY = -scrollSpeed * factor;
        } else if (y > windowHeight - scrollZone) {
          // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ (—á–µ–º –±–ª–∏–∂–µ –∫ –Ω–∏–∑—É, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ)
          const factor = Math.max(0, 1 - (windowHeight - y) / scrollZone);
          scrollY = scrollSpeed * factor;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
        if (x < scrollZone) {
          const factor = Math.max(0, 1 - x / scrollZone);
          scrollX = -scrollSpeed * factor;
        } else if (x > windowWidth - scrollZone) {
          const factor = Math.max(0, 1 - (windowWidth - x) / scrollZone);
          scrollX = scrollSpeed * factor;
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª
        if (scrollY !== 0 || scrollX !== 0) {
          // –°–∫—Ä–æ–ª–ª –æ–∫–Ω–∞
          window.scrollBy({
            top: scrollY,
            left: scrollX,
            behavior: 'auto'
          });
          
          // –°–∫—Ä–æ–ª–ª –≤—Å–µ—Ö —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          const scrollableElements = document.querySelectorAll('.card, .container');
          scrollableElements.forEach(el => {
            if (el.scrollHeight > el.clientHeight && scrollY !== 0) {
              el.scrollTop += scrollY;
            }
            if (el.scrollWidth > el.clientWidth && scrollX !== 0) {
              el.scrollLeft += scrollX;
            }
          });
        }
        
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª
        this.scrollAnimationFrame = requestAnimationFrame(scrollLoop);
      };
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª
      this.scrollAnimationFrame = requestAnimationFrame(scrollLoop);
    },

    // ============================================
    // DRAG AND DROP (DESKTOP)
    // ============================================
    /**
     * –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (desktop)
     * @param {object} w - –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
     */
    dragStart(w) {
      this.drag = w;
      this.draggingItem = w.en || w.text || null;
      this.currentDragPosition = null;
    },

    /**
     * –ö–æ–Ω–µ—Ü –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (desktop)
     */
    dragEnd() {
      this.stopAutoScroll();
      this.drag = null;
      this.draggingItem = null;
      this.dragOver = null;
    },

    /**
     * –í—Ö–æ–¥ –≤ –∑–æ–Ω—É –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
     * @param {object} z - –ó–æ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
     */
    dragEnter(z) {
      this.dragOver = z;
    },

    /**
     * –í—ã—Ö–æ–¥ –∏–∑ –∑–æ–Ω—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
     * @param {object} z - –ó–æ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
     */
    dragLeave(z) {
      if (this.dragOver === z) this.dragOver = null;
    },

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ (desktop)
     * @param {Event} e - –°–æ–±—ã—Ç–∏–µ dragover
     */
    dragOverHandler(e) {
      if (this.drag) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
        this.autoScroll(e.clientX, e.clientY);
      }
    },

    /**
     * –°–±—Ä–æ—Å —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∑–æ–Ω—É
     * @param {number} index - –ò–Ω–¥–µ–∫—Å –∑–æ–Ω—ã
     */
    drop(index) {
      if (this.drag) {
        const target = this.activeTask.data[index];
        target.answer = this.drag.en || this.drag.text || '';
      }
      this.stopAutoScroll();
      this.drag = null;
      this.draggingItem = null;
      this.dragOver = null;
    },

    // ============================================
    // TOUCH SUPPORT (MOBILE + MULTITOUCH)
    // ============================================
    /**
     * –ù–∞—á–∞–ª–æ –∫–∞—Å–∞–Ω–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º—É–ª—å—Ç–∏—Ç–∞—á–∞)
     * @param {object} item - –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
     * @param {Event} e - –°–æ–±—ã—Ç–∏–µ touch
     */
    touchStart(item, e) {
      const t = e.touches && e.touches[0];
      if (!t) return;

      this.touchDragItem = item;
      this.drag = item;
      this.draggingItem = item.en || item.text || null;
      this.touchStartPos = { x: t.clientX, y: t.clientY };
      this.currentDragPosition = { x: t.clientX, y: t.clientY };

      // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–∏–∑—Ä–∞–∫
      this.createTouchGhost(this.draggingItem, t.clientX, t.clientY);
    },

    /**
     * –î–≤–∏–∂–µ–Ω–∏–µ –∫–∞—Å–∞–Ω–∏—è (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ –º—É–ª—å—Ç–∏—Ç–∞—á–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–∫—Ä–æ–ª–ª–æ–º)
     * @param {Event} e - –°–æ–±—ã—Ç–∏–µ touch
     */
    touchMove(e) {
      const t = e.touches && e.touches[0];
      if (!t || !this.touchDragItem) return;

      // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Å–∞–Ω–∏–π, —Ä–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤—Ç–æ—Ä—ã–º –ø–∞–ª—å—Ü–µ–º
      if (e.touches.length > 1) {
        // –í—Ç–æ—Ä–æ–π –ø–∞–ª–µ—Ü –º–æ–∂–µ—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å - –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
        return;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
      this.autoScroll(t.clientX, t.clientY);

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–∑—Ä–∞–∫–∞
      this.moveTouchGhost(t.clientX, t.clientY);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–¥ –∫–∞–∫–æ–π –∑–æ–Ω–æ–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è
      const el = document.elementFromPoint(t.clientX, t.clientY);
      const dz = el ? el.closest && el.closest('.dropzone') : null;

      if (dz && dz.dataset && typeof dz.dataset.dropIndex !== 'undefined') {
        const idx = Number(dz.dataset.dropIndex);
        this.dragOver = this.activeTask && this.activeTask.data ? this.activeTask.data[idx] : null;
      } else {
        this.dragOver = null;
      }

      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º
      // (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–æ–ª–ª –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ autoScroll)
      e.preventDefault();
    },

    /**
     * –ö–æ–Ω–µ—Ü –∫–∞—Å–∞–Ω–∏—è
     * @param {Event} e - –°–æ–±—ã—Ç–∏–µ touch
     */
    touchEnd(e) {
      const t = (e.changedTouches && e.changedTouches[0]) || null;
      let dropped = false;

      if (t && this.touchDragItem) {
        const el = document.elementFromPoint(t.clientX, t.clientY);
        const dz = el ? el.closest && el.closest('.dropzone') : null;

        if (dz && dz.dataset && typeof dz.dataset.dropIndex !== 'undefined') {
          const idx = Number(dz.dataset.dropIndex);
          if (this.drag) {
            const target = this.activeTask.data[idx];
            target.answer = this.drag.en || this.drag.text || '';
            dropped = true;
          }
        }
      }

      // –û—á–∏—Å—Ç–∫–∞
      this.stopAutoScroll();
      this.removeTouchGhost();
      this.drag = null;
      this.draggingItem = null;
      this.dragOver = null;
      this.touchDragItem = null;
      this.touchStartPos = null;
    },

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–∑—Ä–∞–∫–∞ –¥–ª—è touch
     * @param {string} text - –¢–µ–∫—Å—Ç –ø—Ä–∏–∑—Ä–∞–∫–∞
     * @param {number} x - X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
     * @param {number} y - Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
     */
    createTouchGhost(text, x = null, y = null) {
      this.removeTouchGhost();
      const g = document.createElement('div');
      g.className = 'touch-ghost';
      g.textContent = text || '';
      document.body.appendChild(g);
      this.touchGhost = g;

      if (x !== null && y !== null) {
        g.style.left = x + 'px';
        g.style.top = y + 'px';
      }
    },

    /**
     * –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–∑—Ä–∞–∫–∞
     * @param {number} x - X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
     * @param {number} y - Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
     */
    moveTouchGhost(x, y) {
      if (!this.touchGhost) return;
      this.touchGhost.style.left = x + 'px';
      this.touchGhost.style.top = y + 'px';
    },

    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–∑—Ä–∞–∫–∞
     */
    removeTouchGhost() {
      if (this.touchGhost && this.touchGhost.parentNode) {
        this.touchGhost.parentNode.removeChild(this.touchGhost);
      }
      this.touchGhost = null;
    },

    // ============================================
    // –§–£–ù–ö–¶–ò–ò –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–Ø
    // ============================================
    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
     */
    async loadStudents() {
      this.teacherError = '';
      const res = await this.fetchSafe(this.endpoints.teacherApi + '/students');
      if (!res.ok) {
        this.students = [];
        this.teacherError = (res.json?.error) ? res.json.error : res.text || 'Unknown error';
        return;
      }

      try {
        this.students = JSON.parse(JSON.stringify(res.json || []));
      } catch (e) {
        this.students = [];
        this.teacherError = 'Invalid students data';
      }
    },

    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
     */
    async addStudent() {
      if (!this.newStudent) return;

      const res = await this.fetchSafe(this.endpoints.studentsApi + '/students', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ login: this.newStudent })
      });

      if (!res.ok) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞: ' + (res.json?.error || res.text));
        return;
      }

      this.newStudent = '';
      await this.loadStudents();
    },

    // ============================================
    // –†–ê–ë–û–¢–ê –° –ë–ï–ô–î–ñ–ê–ú–ò
    // ============================================
    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–µ–π–¥–∂–µ–π
     */
    async loadAvailableBadges() {
      const res = await this.fetchSafe(this.endpoints.teacherApi + '/badges');
      if (!res.ok) {
        this.availableBadges = [];
        return;
      }

      this.availableBadges = res.json || [];
      if (!this.selectedBadgeId && this.availableBadges.length) {
        this.selectedBadgeId = this.availableBadges[0].id;
      }
    },

    /**
     * –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –±–µ–π–¥–∂–∞
     * @param {string} login - –õ–æ–≥–∏–Ω —Å—Ç—É–¥–µ–Ω—Ç–∞
     */
    openBadgeModal(login) {
      this.badgeTargetStudent = login;
      this.selectedBadgeId = this.availableBadges.length ? this.availableBadges[0].id : null;
      this.showBadgeModal = true;
    },

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –±–µ–π–¥–∂–∞
     */
    closeBadgeModal() {
      this.showBadgeModal = false;
      this.badgeTargetStudent = null;
      this.selectedBadgeId = null;
    },

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –±–µ–π–¥–∂–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
     * @param {string} title - –ù–∞–∑–≤–∞–Ω–∏–µ –±–µ–π–¥–∂–∞
     * @returns {string} –ò–∫–æ–Ω–∫–∞
     */
    badgeIconFromTitle(title) {
      const b = this.availableBadges.find(x => x.title === title);
      return b ? (b.icon || title.slice(0, 2)) : title.slice(0, 2);
    },

    /**
     * –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏ –±–µ–π–¥–∂–∞
     */
    async confirmGiveBadge() {
      if (!this.badgeTargetStudent || !this.selectedBadgeId) return;

      const badgeObj = this.availableBadges.find(b => b.id === this.selectedBadgeId);
      const badgeTitle = badgeObj ? badgeObj.title : this.selectedBadgeId;

      const res = await this.fetchSafe(
        `${this.endpoints.teacherApi}/students/${encodeURIComponent(this.badgeTargetStudent)}/badges`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ badge: badgeTitle })
        }
      );

      if (!res.ok) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–∞—Ç—å –∞—á–∏–≤–∫—É: ' + (res.json?.error || res.text));
        return;
      }

      await this.loadStudents();
      this.closeBadgeModal();
    },

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–µ–π–¥–∂–∞
     */
    async createBadge() {
      if (!this.newBadgeId || !this.newBadgeTitle) {
        alert('–í–≤–µ–¥–∏—Ç–µ id –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');
        return;
      }

      const payload = {
        id: this.newBadgeId,
        title: this.newBadgeTitle,
        icon: this.newBadgeIcon || ''
      };

      const res = await this.fetchSafe(this.endpoints.teacherApi + '/badges', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±–µ–π–¥–∂: ' + (res.json?.error || res.text));
        return;
      }

      await this.loadAvailableBadges();
      this.newBadgeId = '';
      this.newBadgeTitle = '';
      this.newBadgeIcon = '';
      alert('–ë–µ–π–¥–∂ —Å–æ–∑–¥–∞–Ω');
    }
  },

  mounted() {
    try {
      console.log('[frontend] app mounted, Vue.compile =', typeof Vue.compile);
    } catch (e) {}
    try {
      window.__APP = this;
    } catch (e) {}

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ dragover –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ (desktop)
    // –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ–≥–¥–∞ –∫—É—Ä—Å–æ—Ä –Ω–µ –Ω–∞–¥ dropzone, –Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
    document.addEventListener('dragover', (e) => {
      if (this.drag) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
        this.autoScroll(e.clientX, e.clientY);
      }
    }, { passive: false });
  }
}).mount('#app');
</script>
</body>
</html>